{"version":3,"sources":["file:///Users/xiejiapei/Documents/3D%20Game/Car/assets/script/fight/customerManager.ts"],"names":["_decorator","Component","Animation","Vec3","isValid","clientEvent","fightConstants","audioManager","constant","resourceUtil","poolManager","ccclass","property","customerManager","nodeCustomer","_targetPos","_callback","undefined","_offset","customerId","retryTimes","start","newOrder","Math","floor","random","CUSTOMER_MAX_CNT","dispatchEvent","CUSTOMER_TALK_TIME","NEW_ORDER","greeting","carWorldPos","direction","callback","instance","putNode","getCustomer","toString","err","prefab","console","error","getNode","node","active","tmpVec3","multiplyScalar","add","customerPos","clone","targetPos","setWorldPosition","x","eulerAngles","z","playSound","AUDIO_SOUND","customerMove","IN_CAR","scheduleOnce","INTO_THE_CAR","takeCustomer","isLastCustomer","y","posCur","GET_MONEY","ani","getComponent","play","subtract","worldPosition","moveSpeed","update","deltaTime","posWorld","getWorldPosition","offset","lengthSqr","onMoveOver","reset","getState","stop","destroy"],"mappings":"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","sourcesContent":["// Learn cc.Class:\n//  - [Chinese] http://docs.cocos.com/creator/manual/zh/scripting/class.html\n//  - [English] http://www.cocos2d-x.org/docs/creator/en/scripting/class.html\n// Learn Attribute:\n//  - [Chinese] http://docs.cocos.com/creator/manual/zh/scripting/reference/attributes.html\n//  - [English] http://www.cocos2d-x.org/docs/creator/en/scripting/reference/attributes.html\n// Learn life-cycle callbacks:\n//  - [Chinese] http://docs.cocos.com/creator/manual/zh/scripting/life-cycle-callbacks.html\n//  - [English] http://www.cocos2d-x.org/docs/creator/en/scripting/life-cycle-callbacks.html\n\nimport { _decorator, Component, Node, Animation, Vec3, isValid } from \"cc\";\nimport { clientEvent } from \"../framework/clientEvent\";\nimport { fightConstants } from \"./fightConstants\";\nimport { audioManager } from \"../framework/audioManager\";\nimport { constant } from \"../framework/constant\";\nimport { resourceUtil } from \"../framework/resourceUtil\";\nimport { poolManager } from \"../framework/poolManager\";\nconst { ccclass, property } = _decorator;\n\n@ccclass(\"customerManager\")\nexport class customerManager extends Component {\n    @property\n    moveSpeed: number = 1;\n\n    nodeCustomer: Node | null = null;\n    _targetPos: Vec3 | null = null;\n    _callback: (() => void) | undefined = undefined;\n    _offset: Vec3 | null = null;\n    customerId: number = -1;\n    retryTimes: number = 0;\n\n    start() {\n        // Your initialization goes here.\n    }\n\n\n    /**\n     * 触发新订单\n     *\n     * @memberof customerManager\n     */\n    newOrder() {\n        //随机个乘客给他\n        this.customerId = Math.floor(Math.random() * constant.CUSTOMER_MAX_CNT) + 1;\n\n        clientEvent.dispatchEvent('showTalk', this.customerId, fightConstants.CUSTOMER_TALK_TIME.NEW_ORDER);\n    }\n\n    /**\n     * 接客\n     * @param {Vec3} carWorldPos 车辆当前位置\n     * @param direction 乘客的方向\n     * @param callback 乘客上车后的回调函数\n     */\n    greeting(carWorldPos: Vec3, direction: Vec3, callback: () => void) {\n        if (this.customerId === -1) {\n            //还没有产生过乘客\n            //随机个乘客给他\n            this.customerId = Math.floor(Math.random() * constant.CUSTOMER_MAX_CNT) + 1;\n        }\n\n        //使用订单时产生的乘客\n        if (this.nodeCustomer) {\n            poolManager.instance.putNode(this.nodeCustomer);\n            this.nodeCustomer = null;\n        }\n\n        resourceUtil.getCustomer(this.customerId.toString(), (err, prefab) => {\n            if (err) {\n                console.error(err);\n                //尝试重新加载一次\n                if (this.retryTimes < 3) {\n                    this.greeting(carWorldPos, direction, callback);\n                }\n                return;\n            }\n\n            this.retryTimes = 0;\n\n\n            this.nodeCustomer = poolManager.instance.getNode(prefab, this.node);\n            this.nodeCustomer.active = true;\n\n            // direction = new Vec3(direction.x, direction.y, direction.z);\n\n            let tmpVec3 = new Vec3();\n            Vec3.multiplyScalar(tmpVec3, direction, 1.3);\n            Vec3.add(tmpVec3, carWorldPos, tmpVec3);\n            let customerPos = tmpVec3.clone();\n\n            Vec3.multiplyScalar(tmpVec3, direction, 0.25);\n            Vec3.add(tmpVec3, carWorldPos, tmpVec3);\n            let targetPos = tmpVec3.clone();\n\n            this.nodeCustomer.setWorldPosition(customerPos);\n\n            if (direction.x !== 0) {\n                if (direction.x > 0) {\n                    this.nodeCustomer.eulerAngles = new Vec3(0, 270, 0);\n                } else {\n                    this.nodeCustomer.eulerAngles = new Vec3(0, 90, 0);\n                }\n            } else {\n                if (direction.z > 0) {\n                    this.nodeCustomer.eulerAngles = new Vec3(0, 180, 0);\n                } else {\n                    this.nodeCustomer.eulerAngles = new Vec3(0, 0, 0);\n                }\n            }\n\n            audioManager.instance.playSound(constant.AUDIO_SOUND.NEW_ORDER);\n\n            this.customerMove(targetPos, () => {\n                audioManager.instance.playSound(constant.AUDIO_SOUND.IN_CAR);\n\n                //接完客后\n                callback && callback();\n\n                //触发乘客问候\n                this.scheduleOnce(() => {\n                    clientEvent.dispatchEvent('showTalk', this.customerId, fightConstants.CUSTOMER_TALK_TIME.INTO_THE_CAR);\n                }, 1);\n\n            });\n        });\n\n\n    }\n\n    /**\n     * 送客\n     * @param carWorldPos 车辆当前位置\n     * @param direction 乘客前往的方向\n     * @param isLastCustomer 是否最后一位乘客\n     * @param callback 乘客上车后的回调函数\n     */\n    takeCustomer(carWorldPos: Vec3, direction: Vec3, isLastCustomer: boolean, callback?: () => void) {\n        if (!this.nodeCustomer) {\n            //没有顾客可能有异常直接过\n            if(callback){\n                callback();\n            }\n\n            return;\n        }\n\n        direction = new Vec3(direction.x, direction.y, direction.z);\n\n        let tmpVec3 = new Vec3();\n        Vec3.multiplyScalar(tmpVec3, direction, 0.25);\n        Vec3.add(tmpVec3, carWorldPos, tmpVec3);\n        let posCur = tmpVec3.clone();\n\n        this.nodeCustomer.active = true;\n        this.nodeCustomer.setWorldPosition(posCur);\n        if (direction.x !== 0) {\n            if (direction.x > 0) {\n                this.nodeCustomer.eulerAngles = new Vec3(0, 90, 0);\n            } else {\n                this.nodeCustomer.eulerAngles = new Vec3(0, 270, 0);\n            }\n        } else {\n            if (direction.z > 0) {\n                this.nodeCustomer.eulerAngles = new Vec3(0, 0, 0);\n            } else {\n                this.nodeCustomer.eulerAngles = new Vec3(0, 180, 0);\n            }\n        }\n\n        Vec3.multiplyScalar(tmpVec3, direction, 1.3);\n        Vec3.add(tmpVec3, carWorldPos, tmpVec3);\n        let targetPos = tmpVec3.clone();\n\n        audioManager.instance.playSound(constant.AUDIO_SOUND.GET_MONEY);\n\n        this.customerMove(targetPos, () => {\n            //送完客后\n            if (callback){\n                callback()\n            }\n\n            //2秒后触发新订单\n            //需要检测是否已经结束\n            if (!isLastCustomer) {\n                //触发新订单\n                this.scheduleOnce(() => {\n                    this.newOrder();\n                }, 2);\n            }\n        });\n    }\n\n    customerMove(targetPos: Vec3, callback:() => void) {\n        this._targetPos = targetPos;\n        this._callback = callback;\n\n        let ani = this.nodeCustomer!.getComponent(Animation)!;\n        ani.play('walk');\n\n        this._offset = Vec3.subtract(new Vec3(), this._targetPos, this.nodeCustomer!.worldPosition);\n        this._offset.multiplyScalar(this.moveSpeed);\n    }\n\n    update(deltaTime: number) {\n        // Your update function goes here.\n\n        if (this._targetPos && this.nodeCustomer) {\n            let posWorld = this.nodeCustomer.getWorldPosition();\n            let offset = new Vec3();\n            Vec3.multiplyScalar(offset, this._offset!, deltaTime);\n            posWorld.add(offset);\n\n            if (Vec3.subtract(offset, posWorld, this._targetPos).lengthSqr() < 0.01) {\n                //到达目标\n                this.onMoveOver();\n            } else {\n                this.nodeCustomer.setWorldPosition(posWorld);\n            }\n        }\n    }\n\n    onMoveOver() {\n        this.nodeCustomer!.setWorldPosition(this._targetPos!);\n        this.nodeCustomer!.active = false;\n        this._targetPos = null;\n        this._callback && this._callback();\n    }\n\n    reset() {\n        if (this.nodeCustomer && isValid(this.nodeCustomer)) {\n            let ani = this.nodeCustomer.getComponent(Animation)!;\n            // ani.stop();\n            ani.getState('walk').stop();\n            this.nodeCustomer.destroy();\n            this.nodeCustomer = null;\n        }\n\n        this.customerId = -1;\n    }\n}\n"]}
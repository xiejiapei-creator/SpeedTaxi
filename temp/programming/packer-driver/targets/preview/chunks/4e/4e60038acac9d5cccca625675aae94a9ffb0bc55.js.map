{"version":3,"sources":["file:///Users/xiejiapei/NewProject_1/assets/script/framework/uiManager.ts"],"names":["_decorator","find","isValid","resourceUtil","poolManager","tips","ccclass","property","SHOW_STR_INTERVAL_TIME","uiManager","dictSharedPanel","dictLoading","arrPopupDialog","showTipsTime","instance","_instance","showDialog","panelPath","args","cb","idxSplit","lastIndexOf","scriptName","slice","hasOwnProperty","panel","parent","active","script","getComponent","show","apply","createUI","err","node","isCloseBeforeShow","console","error","hideDialog","callback","pushToPopupSeq","param","popupDialog","isShow","push","checkPopupSeq","insertToPopupSeq","index","splice","shiftFromPopupSeq","shift","length","first","showTips","content","now","Date","spareTime","self","setTimeout","tipsLabel","_showTipsAni","bind","getUIPrefabRes","prefab","tipsNode","getNode","tipScript"],"mappings":"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","sourcesContent":["// Learn cc.Class:\n//  - [Chinese] http://docs.cocos.com/creator/manual/zh/scripting/class.html\n//  - [English] http://www.cocos2d-x.org/docs/creator/en/scripting/class.html\n// Learn Attribute:\n//  - [Chinese] http://docs.cocos.com/creator/manual/zh/scripting/reference/attributes.html\n//  - [English] http://www.cocos2d-x.org/docs/creator/en/scripting/reference/attributes.html\n// Learn life-cycle callbacks:\n//  - [Chinese] http://docs.cocos.com/creator/manual/zh/scripting/life-cycle-callbacks.html\n//  - [English] http://www.cocos2d-x.org/docs/creator/en/scripting/life-cycle-callbacks.html\n\nimport { _decorator, Component, Node, find, isValid } from \"cc\";\nimport { resourceUtil } from \"./resourceUtil\";\nimport { poolManager } from \"./poolManager\";\nimport { tips } from \"../ui/common/tips\";\nconst { ccclass, property } = _decorator;\n\nconst SHOW_STR_INTERVAL_TIME = 800;\n\ninterface IPanel extends Component {\n    show?: Function;\n    hide?: Function;\n}\n\n@ccclass(\"uiManager\")\nexport class uiManager {\n\n    dictSharedPanel: { [path: string]: Node } = {}\n    dictLoading: { [path: string]: boolean } = {};\n    arrPopupDialog: {\n        panelPath: string,\n        scriptName?: string,\n        param: any,\n        isShow: boolean\n    }[] = [];\n    showTipsTime: number = 0\n\n\n    static _instance: uiManager;\n\n    static get instance() {\n        if (this._instance) {\n            return this._instance;\n        }\n\n        this._instance = new uiManager();\n        return this._instance;\n    }\n\n\n    /**\n     * 显示单例界面\n     * @param {String} panelPath\n     * @param {Array} args\n     * @param {Function} cb 回调函数，创建完毕后回调\n     */\n    showDialog (panelPath: string, args?: any, cb?: Function) {\n        if (this.dictLoading[panelPath]) {\n            return;\n        }\n\n        let idxSplit = panelPath.lastIndexOf('/');\n        let scriptName = panelPath.slice(idxSplit + 1);\n\n        if (!args) {\n            args = [];\n        }\n\n        if (this.dictSharedPanel.hasOwnProperty(panelPath)) {\n            let panel = this.dictSharedPanel[panelPath];\n            if (isValid(panel)) {\n                panel.parent = find(\"Canvas\");\n                panel.active = true;\n                let script = panel.getComponent(scriptName) as IPanel;\n                if (script.show) {\n                    script.show.apply(script, args);\n                }\n\n                cb && cb(script);\n\n                return;\n            }\n        }\n\n        this.dictLoading[panelPath] = true;\n        resourceUtil.createUI(panelPath, (err, node) => {\n            //判断是否有可能在显示前已经被关掉了？\n            let isCloseBeforeShow = false;\n            if (!this.dictLoading[panelPath]) {\n                //已经被关掉\n                isCloseBeforeShow = true;\n            }\n\n            this.dictLoading[panelPath] = false;\n            if (err) {\n                console.error(err);\n                return;\n            }\n\n            // node.zIndex = 100;\n            this.dictSharedPanel[panelPath] = node!;\n\n            let script = node!.getComponent(scriptName)! as IPanel;\n            if (script.show) {\n                script.show.apply(script, args);\n            }\n\n            cb && cb(script);\n\n            if (isCloseBeforeShow) {\n                //如果在显示前又被关闭，则直接触发关闭掉\n                this.hideDialog(panelPath);\n            }\n        });\n    }\n\n    /**\n     * 隐藏单例界面\n     * @param {String} panelPath\n     * @param {fn} callback\n     */\n    hideDialog (panelPath: string, callback?: Function) {\n        if (this.dictSharedPanel.hasOwnProperty(panelPath)) {\n            let panel = this.dictSharedPanel[panelPath];\n            if (panel && isValid(panel)) {\n                // let ani = panel.getComponent('animationUI');\n                // if (ani) {\n                //     ani.close(() => {\n                //         panel.parent = null;\n                //         if (callback && typeof callback === 'function') {\n                //             callback();\n                //         }\n                //     });\n                // } else {\n                    panel.parent = null;\n                    if (callback && typeof callback === 'function') {\n                        callback();\n                    }\n                // }\n            } else if (callback && typeof callback === 'function') {\n                callback();\n            }\n        }\n\n        this.dictLoading[panelPath] = false;\n    }\n\n    /**\n     * 将弹窗加入弹出窗队列\n     * @param {string} panelPath\n     * @param {string} scriptName\n     * @param {*} param\n     */\n    pushToPopupSeq (panelPath: string, scriptName: string, param: any) {\n        let popupDialog = {\n            panelPath: panelPath,\n            scriptName: scriptName,\n            param: param,\n            isShow: false\n        };\n\n        this.arrPopupDialog.push(popupDialog);\n\n        this.checkPopupSeq();\n    }\n\n    /**\n     * 将弹窗加入弹出窗队列\n     * @param {number} index\n     * @param {string} panelPath\n     * @param {string} scriptName\n     * @param {*} param\n     */\n    insertToPopupSeq (index: number, panelPath: string, param: any) {\n        let popupDialog = {\n            panelPath: panelPath,\n            param: param,\n            isShow: false\n        };\n\n        this.arrPopupDialog.splice(index, 0, popupDialog);\n        //this.checkPopupSeq();\n    }\n\n    /**\n     * 将弹窗从弹出窗队列中移除\n     * @param {string} panelPath\n     */\n    shiftFromPopupSeq (panelPath: string) {\n        this.hideDialog(panelPath, () => {\n            if (this.arrPopupDialog[0] && this.arrPopupDialog[0].panelPath === panelPath) {\n                this.arrPopupDialog.shift();\n                this.checkPopupSeq();\n            }\n        })\n    }\n\n    /**\n     * 检查当前是否需要弹窗\n     */\n    checkPopupSeq () {\n        if (this.arrPopupDialog.length > 0) {\n            let first = this.arrPopupDialog[0];\n\n            if (!first.isShow) {\n                this.showDialog(first.panelPath, first.param);\n                this.arrPopupDialog[0].isShow = true;\n            }\n        }\n    }\n\n    // update (deltaTime: number) {\n    //     // Your update function goes here.\n    // }\n\n    /**\n     * 显示提示\n     * @param {String} content\n     * @param {Function} cb\n     */\n    showTips (content: string, cb?: Function) {\n        var now = Date.now();\n        if (now - this.showTipsTime < SHOW_STR_INTERVAL_TIME) {\n            var spareTime = SHOW_STR_INTERVAL_TIME - (now - this.showTipsTime);\n            const self = this;\n            setTimeout(function (tipsLabel, callback) {\n                self._showTipsAni(tipsLabel, callback);\n            }.bind(this, content, cb), spareTime);\n\n            this.showTipsTime = now + spareTime;\n        } else {\n            this._showTipsAni(content, cb);\n            this.showTipsTime = now;\n        }\n    }\n\n    /**\n     * 内部函数\n     * @param {String} content\n     * @param {Function} cb\n     */\n    _showTipsAni(content: string, cb?: Function) {\n        //todo 临时添加方案，后期需要将这些代码移到具体界面\n        resourceUtil.getUIPrefabRes('common/tips', (err, prefab) => {\n            if (err) {\n                return;\n            }\n\n            let tipsNode = poolManager.instance.getNode(prefab!, find(\"Canvas\")!) as Node;\n            let tipScript = tipsNode.getComponent(tips)!;\n            tipScript.show(content, cb);\n        });\n    }\n}\n"]}
{"version":3,"sources":["file:///Users/xiejiapei/Documents/Car/assets/script/main.ts"],"names":["_decorator","Component","Label","director","assetManager","localConfig","playerData","configuration","loading","i18n","ccclass","property","init","main","retryTimes","uid","curProgress","isLoginFinished","isSubPackageFinished","isConfigLoaded","start","loadingUI","show","instance","syncServerTime","Date","now","updateProgress","t","loadConfig","lbVersion","string","getVersion","loadMainScene","loadGlobalCache","userId","generateGuestAccount","startLogin","downloadGameRes","console","log","setUserId","userLogin","loadFromCache","playerInfo","createDate","undefined","createPlayerInfo","cb","showSubPackageError","loadGameSubPackage","loadBundle","err","error","preloadScene","loadScene"],"mappings":"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","sourcesContent":["// Learn cc.Class:\n//  - [Chinese] http://docs.cocos.com/creator/manual/zh/scripting/class.html\n//  - [English] http://www.cocos2d-x.org/docs/creator/en/scripting/class.html\n// Learn Attribute:\n//  - [Chinese] http://docs.cocos.com/creator/manual/zh/scripting/reference/attributes.html\n//  - [English] http://www.cocos2d-x.org/docs/creator/en/scripting/reference/attributes.html\n// Learn life-cycle callbacks:\n//  - [Chinese] http://docs.cocos.com/creator/manual/zh/scripting/life-cycle-callbacks.html\n//  - [English] http://www.cocos2d-x.org/docs/creator/en/scripting/life-cycle-callbacks.html\n\nimport { _decorator, Component, Label, profiler, director, assetManager } from \"cc\";\n// import { updateValueLabel } from \"./ui/common/updateValueLabel\";\nimport { localConfig } from \"./framework/localConfig\";\nimport { playerData } from \"./framework/playerData\";\nimport { configuration } from \"./framework/configuration\";\nimport { audioManager } from \"./framework/audioManager\";\nimport { constant } from \"./framework/constant\";\n// import { gameLogic } from \"./logic/gameLogic\"\nimport { loading } from \"./ui/common/loading\";\nimport { i18n } from \"./i18nMaster/runtime-scripts/LanguageData\";\n\nconst { ccclass, property } = _decorator;\n\n// cc.gameSpace = {};\n// cc.gameSpace.TIME_SCALE = 1;\n// cc.gameSpace.isStop = false;\n// cc.gameSpace.isConfigLoadFinished = false;\ni18n.init('zh');\n\n@ccclass(\"main\")\nexport class main extends Component {\n    /* class member could be defined like this */\n    // dummy = '';\n\n    @property(Label)\n    lbVersion: Label = null!;\n\n    @property(loading)\n    loadingUI: loading = null!;\n\n    retryTimes: number = 0;\n    uid: string = '';\n    curProgress: number = 0;\n    isLoginFinished: boolean = false;\n    isSubPackageFinished: boolean = false;\n    isConfigLoaded: boolean = false;\n\n    start () {\n        // profiler.hideStats();\n\n        this.loadingUI.show();\n\n        //TODO 后续将由服务器提供时间\n        playerData.instance.syncServerTime(Date.now());\n\n        // Your initialization goes here.\n        this.curProgress = 5; //起始10%\n        this.loadingUI.updateProgress(this.curProgress, i18n.t(\"main.dataLoading\"));\n        localConfig.instance.loadConfig(()=>{\n            // cc.gameSpace.isConfigLoadFinished = true;\n\n            this.lbVersion.string = `Version. ${localConfig.instance.getVersion()}`;\n            this.isConfigLoaded = true;\n            this.loadMainScene();\n        });\n\n\n        this.curProgress += 5;\n        if (this.loadingUI) {\n            this.loadingUI.updateProgress(this.curProgress, i18n.t(\"main.dataLoadOver\"));\n        }\n\n        this.curProgress += 5;\n        // this.loadingUI.updateProgress(this.curProgress, '登录中...');\n        //其他环境下，直接开始加载资源\n        this.curProgress += 15;\n        this.loadingUI.updateProgress(this.curProgress, i18n.t(\"main.gameResourceLoading\"));\n\n        //普通用户登录\n        playerData.instance.loadGlobalCache();\n        if (!playerData.instance.userId) {\n            //需要创建个账号\n            this.uid = configuration.generateGuestAccount();\n        } else {\n            this.uid = playerData.instance.userId;\n        }\n\n        this.startLogin();\n\n        this.downloadGameRes(()=>{\n            console.log('subpackage download finished!');\n            this.isSubPackageFinished = true;\n            this.loadMainScene();\n        })\n    }\n\n    startLogin () {\n        configuration.instance.setUserId(this.uid);\n\n        playerData.instance.syncServerTime(Date.now());\n        this.userLogin();\n    }\n\n    userLogin () {\n        playerData.instance.loadFromCache();\n\n        if (playerData.instance.playerInfo.createDate === undefined) {\n            //表示没有创建过\n            playerData.instance.createPlayerInfo();\n        }\n\n        console.log('login finished!');\n        this.isLoginFinished = true;\n        this.loadMainScene();\n\n    }\n\n    downloadGameRes (cb?: Function) {\n        //不用加载子包，直接+30\n        this.curProgress += 15;\n        this.loadingUI.updateProgress(this.curProgress);\n\n        cb && cb();\n    }\n\n    showSubPackageError () {\n\n    }\n\n    loadGameSubPackage (cb?: Function) {\n        this.loadingUI.updateProgress(this.curProgress, i18n.t(\"main.audioResourceLoading\"));\n        assetManager.loadBundle('resources', (err) =>{\n            this.curProgress += 5;\n            this.loadingUI.updateProgress(this.curProgress, i18n.t(\"main.audioResourceLoading\"));\n            if (err) {\n                this.showSubPackageError();\n                return console.error(err);\n            }\n\n            assetManager.loadBundle('textures', (err) =>{\n                this.curProgress += 5;\n                this.loadingUI.updateProgress(this.curProgress, i18n.t(\"main.mappingResourceLoading\"));\n                if (err) {\n                    this.showSubPackageError();\n                    return console.error(err);\n                }\n\n                assetManager.loadBundle('model', (err) =>{\n                    this.curProgress += 5;\n                    this.loadingUI.updateProgress(this.curProgress, i18n.t(\"main.modelResourceLoading\"));\n                    if (err) {\n                        this.showSubPackageError();\n                        return console.error(err);\n                    }\n\n                    cb && cb();\n                });\n            });\n        });\n    }\n\n    loadMainScene () {\n        if (!this.isConfigLoaded || !this.isLoginFinished || !this.isSubPackageFinished) {\n            //配置，子包，登录，三项没有加载成功的话要等下一项\n            return;\n        }\n\n        director.preloadScene('main', (err) => {\n            this.curProgress += 5;\n            this.loadingUI.updateProgress(this.curProgress, i18n.t(\"main.entering\"));\n            if (!err) {\n                director.loadScene('main', function () {\n\n                });\n            }\n        });\n    }\n}\n"]}
{"version":3,"sources":["file:///Users/xiejiapei/Documents/Car/assets/script/ui/online/online.ts"],"names":["_decorator","Component","Sprite","Label","playerData","util","constant","gameLogic","uiManager","clientEvent","ccclass","property","online","currentTime","isOverflow","currentGold","start","onEnable","refresh","perTimeProgress","fillRange","lastTime","instance","getLastOnlineRewardTime","offsetTime","Math","floor","getCurrentTime","ONLINE","MAX_TIME","PROFIT_PER_SECOND","lbGold","string","formatMoney","percent","spTimeProgress","clear","updateLastOnlineRewardTime","onBtnOnlineClick","pro","showDialog","updatePlayerInfo","showFlyReward","REWARD_TYPE","GOLD","dispatchEvent","update","deltaTime","TIME_PER_CIRCLE","progress"],"mappings":"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","sourcesContent":["// Learn cc.Class:\n//  - [Chinese] http://docs.cocos.com/creator/manual/zh/scripting/class.html\n//  - [English] http://www.cocos2d-x.org/docs/creator/en/scripting/class.html\n// Learn Attribute:\n//  - [Chinese] http://docs.cocos.com/creator/manual/zh/scripting/reference/attributes.html\n//  - [English] http://www.cocos2d-x.org/docs/creator/en/scripting/reference/attributes.html\n// Learn life-cycle callbacks:\n//  - [Chinese] http://docs.cocos.com/creator/manual/zh/scripting/life-cycle-callbacks.html\n//  - [English] http://www.cocos2d-x.org/docs/creator/en/scripting/life-cycle-callbacks.html\n\nimport { _decorator, Component, ProgressBarComponent, Sprite, Label } from \"cc\";\nimport { playerData } from \"../../framework/playerData\";\nimport { util } from \"../../framework/util\";\nimport { constant } from \"../../framework/constant\";\nimport { gameLogic } from \"../../logic/gameLogic\";\nimport { uiManager } from \"../../framework/uiManager\";\nimport { clientEvent } from \"../../framework/clientEvent\";\nconst { ccclass, property } = _decorator;\n\n@ccclass(\"online\")\nexport class online extends Component {\n    /* class member could be defined like this */\n    // dummy = '';\n\n    /* use `property` decorator if your want the member to be serializable */\n    // @property\n    // serializableDummy = 0;\n\n    @property(Sprite)\n    spTimeProgress: Sprite = null;     //累积时间进度\n\n    @property(Sprite)\n    perTimeProgress: Sprite = null;    //每次的时间进度，使用sprite的FillRange来修改\n\n    @property(Label)\n    lbGold: Label = null;\n\n    currentTime: number = 0;\n    isOverflow: boolean = false;\n    currentGold: number = 0;\n\n    start () {\n        // Your initialization goes here.\n    }\n\n    onEnable () {\n        //触发界面刷新\n        this.refresh();\n    }\n\n    refresh () {\n        //每圈计时\n        this.currentTime = 0;\n        this.perTimeProgress.fillRange = 0;\n\n        let lastTime = playerData.instance.getLastOnlineRewardTime();\n        let offsetTime = Math.floor((playerData.instance.getCurrentTime() - lastTime) / 1000);\n        offsetTime = offsetTime > 0 ? offsetTime : 0;\n        offsetTime = offsetTime < constant.ONLINE.MAX_TIME ? offsetTime : constant.ONLINE.MAX_TIME;\n        this.isOverflow = offsetTime === constant.ONLINE.MAX_TIME;\n\n\n        //设置当前收益\n        this.currentGold = Math.floor(offsetTime * constant.ONLINE.PROFIT_PER_SECOND);\n        this.lbGold.string = util.formatMoney(this.currentGold);\n\n        //进度条\n        let percent = offsetTime / constant.ONLINE.MAX_TIME;\n        percent = percent > 1 ? 1 : percent;\n        this.spTimeProgress.fillRange = percent;\n\n\n    }\n\n    clear () {\n        this.currentGold = 0;\n        this.lbGold.string = '0';\n        this.spTimeProgress.fillRange = 0;\n        playerData.instance.updateLastOnlineRewardTime(this.currentTime);\n\n        this.isOverflow = false;\n    }\n\n    onBtnOnlineClick () {\n        if (this.currentGold <= 0) {\n            return;\n        }\n\n        let pro = this.spTimeProgress.fillRange;\n        //如果超过了50%要问是否要双倍，否则直接领取\n        if (pro >= 0.5) {\n            //显示弹窗\n            uiManager.instance.showDialog('main/onlineDouble', [this.currentGold, ()=>{\n                this.clear();\n            }]);\n        } else {\n            // gameLogic.addGold(this.currentGold);\n\n            playerData.instance.updatePlayerInfo('gold', this.currentGold);\n\n            //播放特效\n            //....\n            gameLogic.showFlyReward(constant.REWARD_TYPE.GOLD, ()=>{\n                clientEvent.dispatchEvent('updateGold');\n            });\n\n            this.clear();\n        }\n    }\n\n    update (deltaTime: number) {\n        // Your update function goes here.\n        if (!this.isOverflow) {\n            this.currentTime += deltaTime;\n\n            if (this.currentTime > constant.ONLINE.TIME_PER_CIRCLE) {\n                this.refresh();\n            } else {\n                let progress = this.currentTime / constant.ONLINE.TIME_PER_CIRCLE;\n                this.perTimeProgress.fillRange = progress;\n            }\n        }\n    }\n}\n"]}